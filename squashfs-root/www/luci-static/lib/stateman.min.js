!function(p,k){"object"==typeof exports&&"object"==typeof module?module.exports=k():"function"==typeof define&&define.amd?define([],k):"object"==typeof exports?exports.StateMan=k():p.StateMan=k()}(this,function(){return function(p){function k(l){if(d[l])return d[l].exports;var h=d[l]={exports:{},id:l,loaded:!1};return p[l].call(h.exports,h,h.exports,k),h.loaded=!0,h.exports}var d={};return k.m=p,k.c=d,k.p="",k(0)}([function(p,k,d){k=d(1);k.Histery=d(4);k.util=d(3);k.State=d(2);p.exports=k},function(p,
k,d){function l(b){return!1==this instanceof l?new l(b):(b=b||{},this._states={},this._stashCallback=[],this.strict=b.strict,this.current=this.active=this,this.title=b.title,void this.on("end",function(){for(var a,b=this.current;b&&!(a=b.title);)b=b.parent;document.title="function"==typeof a?b.title():String(a||n)}))}k=d(2);var h=d(4),c=(d(5),d(3)),n=document.title,g=k.prototype.state;c.extend(c.emitable(l),{name:"",state:function(b,a){var e=this.active;return"string"==typeof b&&e&&(b=b.replace("~",
e.name),e.parent&&(b=b.replace("^",e.parent.name||""))),g.apply(this,arguments)},start:function(b){return this.history||(this.history=new h(b)),this.history.isStart||(this.history.on("change",c.bind(this._afterPathChange,this)),this.history.start()),this},stop:function(){this.history.stop()},go:function(b,a,e){if(a=a||{},"string"==typeof b&&(b=this.state(b)),b){if("function"==typeof a&&(e=a,a={}),!1!==a.encode){var f=b.encode(a.param);a.path=f;this.nav(f,{silent:!0,replace:a.replace})}return this._go(b,
a,e),this}},nav:function(b,a,e){return"function"==typeof a&&(e=a,a={}),a=a||{},a.path=b,this.history.nav(b,c.extend({silent:!0},a)),a.silent||this._afterPathChange(c.cleanPath(b),a,e),this},decode:function(b){b=b.split("?");var a=this._findQuery(b[1]);b=b[0];b=this._findState(this,b);return b&&c.extend(b.param,a),b},encode:function(b,a){var e=this.state(b);return e?e.encode(a):""},is:function(b,a,e){if(!b)return!1;b=b.name||b;var f=this.current.name;return(e?f===b:0===(f+".").indexOf(b+"."))&&(!a||
c.eql(a,this.param))},_afterPathChange:function(b,a,e){this.emit("history:change",b);var f=this.decode(b);return a=a||{},a.path=b,f?(a.param=f.param,void this._go(f,a,e)):this._notfound(a)},_notfound:function(b){return this.emit("notfound",b)},_go:function(b,a,e){function f(b){g=!0;!1!==b&&n.emit("end");n.pending=null;n._popStash(a)}var g;if(b.hasNext&&this.strict)return this._notfound({name:b.name});a.param=a.param||{};var m=this.current,d=this._findBase(m,b),h=this.path,n=this;"function"==typeof e&&
this._stashCallback.push(e);a.previous=m;a.current=b;m!==b&&(a.stop=function(){f(!1);n.nav(h?h:"/",{silent:!0})},n.emit("begin",a));!0!==g&&(m!==b?(a.phase="permission",this._walk(m,b,a,!0,c.bind(function(e){return!1===e?(h&&this.nav(h,{silent:!0}),f(!1,2),this.emit("abort",a)):(this.pending&&this.pending.stop(),this.pending=a,this.path=a.path,this.current=a.current,this.param=a.param,this.previous=a.previous,a.phase="navigation",void this._walk(m,b,a,!1,c.bind(function(b){return!1===b?(this.current=
this.active,f(!1),this.emit("abort",a)):(this.active=a.current,a.phase="completion",f())},this)))},this))):(n._checkQueryAndParam(d,a),this.pending=null,f()))},_popStash:function(b){var a=this._stashCallback,e=a.length;if(this._stashCallback=[],e)for(var f=0;e>f;f++)a[f].call(this,b)},_walk:function(b,a,e,f,g){var m=this._findBase(b,a);e.basckward=!0;this._transit(b,m,e,f,c.bind(function(b){return!1===b?g(b):(f||this._checkQueryAndParam(m,e),e.basckward=!1,void this._transit(m,a,e,f,g))},this))},
_transit:function(b,a,e,f,g){if(b===a)return g();var m,h=b.name.length>a.name.length,d=h?"leave":"enter";f&&(d="can"+d.replace(/^\w/,function(a){return a.toUpperCase()}));var n=c.bind(function(f){return m===a||!1===f?g(f):(m=m?this._computeNext(m,a):h?b:this._computeNext(b,a),h&&m===a||!m?g(f):void this._moveOn(m,d,e,n))},this);n()},_moveOn:function(b,a,e,f){function g(a){m||(h=!1,m=!0,f(a))}var m=!1,h=!1;e.async=function(){return h=!0,g};e.stop=function(){g(!1)};this.active=b;e=b[a]?b[a](e):!0;return"enter"===
a&&(b.visited=!0),c.isPromise(e)?this._wrapPromise(e,g):void(h||g(e))},_wrapPromise:function(b,a){return b.then(a,function(){a(!1)})},_computeNext:function(b,a){var e=b.name,f=a.name,g=f.split("."),c=e.split("."),h=g.length,d=c.length;return""===e&&(d=0),""===f&&(h=0),h>d?c[d]=g[d]:c.pop(),this.state(c.join("."))},_findQuery:function(b){b=b&&b.split("&");var a={};if(b)for(var e=b.length,a={},f=0;e>f;f++){var g=b[f].split("=");a[g[0]]=g[1]}return a},_findState:function(b,a){var e,f,g=b._states;if(b.hasNext)for(var c in g)if(g.hasOwnProperty(c)&&
(e=this._findState(g[c],a)))return e;return f=b.regexp&&b.decode(a),f?(b.param=f,b):!1},_findBase:function(b,a){if(!b||!a||b==this||a==this)return this;for(var e,f=b;f&&a;){for(e=a;e;){if(f===e)return e;e=e.parent}f=f.parent}},_checkQueryAndParam:function(b,a){for(var e=b;e!==this;)e.update&&e.update(a),e=e.parent}},!0);p.exports=l},function(p,k,d){function l(c){this._states={};this.visited=this._pending=!1;c&&this.config(c)}var h=d(3);l.rCache={};h.extend(h.emitable(l),{state:function(c,d){if("object"===
h.typeOf(c)){for(var g in c)this.state(g,c[g]);return this}var b,a,e,f=this._states;g=0;"string"==typeof c&&(c=c.split("."));var k=c.length;b=this;var m=[];do{if(e=c[g],a=f[e],m.push(e),!a){if(!d)return;a=f[e]=new l;h.extend(a,{parent:b,manager:b.manager||b,name:m.join("."),currentName:e});b.hasNext=!0;a.configUrl()}b=a;f=a._states}while(++g<k);return d?(a.config(d),this):b},config:function(c){c=this._getConfig(c);for(var d in c){var g=c[d];switch(d){case "url":"string"==typeof g&&(this.url=g,this.configUrl());
break;case "events":this.on(g);break;default:this[d]=g}}},_getConfig:function(c){return"function"==typeof c?{enter:c}:c},configUrl:function(){for(var c="",d=this;d;){if(c=("string"==typeof d.url?d.url:d.currentName||"")+"/"+c,0===c.indexOf("^/")){c=c.slice(1);break}d=d.parent}this.pattern=h.cleanPath("/"+c);this.pattern=this.pattern.split("?")[0];h.extend(this,h.normalize(this.pattern),!0)},encode:function(c){c=c||{};var d="%",g=this.matches.replace(/\(([\w-]+)\)/g,function(a,b){var f=c[b]||"";return d+=
b+"%",f})+"?",b;for(b in c)-1===d.indexOf("%"+b+"%")&&(g+=b+"="+c[b]+"&");return h.cleanPath(g.replace(/(?:\?|&)$/,""))},decode:function(c){c=this.regexp.exec(c);var d=this.keys;if(c){for(var g={},b=0,a=d.length;a>b;b++)g[d[b]]=c[b+1];return g}return!1},async:function(){throw Error("please use option.async instead");}});p.exports=l},function(p,k){var d=p.exports={},l=[].slice,h={}.toString;d.extend=function(g,b,a){for(var e in b)(a||void 0===g[e])&&(g[e]=b[e]);return g};d.slice=function(g,b){return l.call(g,
b)};d.typeOf=function(g){return null==g?String(g):h.call(g).slice(8,-1).toLowerCase()};d.eql=function(g,b){var a=d.typeOf(g),e=d.typeOf(b);if(a!==e)return!1;if("object"===a){var a=!0,f;for(f in g)g[f]!==b[f]&&(a=!1);return a}return g===b};d.emitable=function(){function g(a){a=(a||"").split(":");return{event:a[0],namespace:a[1]}}var b={once:function(a,b){var f=function(){b.apply(this,arguments);this.off(a,f)};return this.on(a,f)},on:function(a,b){if("object"==typeof a){for(var f in a)this.on(f,a[f]);
return this}f=g(a);if(a=f.event,a&&"function"==typeof b){var c=this._handles||(this._handles={}),c=c[a]||(c[a]=[]);b._ns=f.namespace;c.push(b)}return this},off:function(a,b){var f=g(a);(a=f.event)&&this._handles||(this._handles={});var c,d=this._handles;if(c=d[a])if(b||f.namespace)for(var d=0,h=c.length;h>d;d++){if(!(b&&b!==c[d]||f.namespace&&c[d]._ns!==f.namespace))return c.splice(d,1),this}else d[a]=[];return this},emit:function(a){var b=g(a);a=b.event;var f,c=d.slice(arguments,1),h=this._handles;
if(!h||!(f=h[a]))return this;for(var h=0,k=f.length;k>h;h++){var n=f[h];b.namespace&&n._ns!==b.namespace||n.apply(this,c)}return this}};return function(a){return a="function"==typeof a?a.prototype:a,d.extend(a,b)}}();d.bind=function(c,b){return function(){return c.apply(b,arguments)}};var c=/\/+/g,n=/\/$/;d.cleanPath=function(d){return("/"+d).replace(c,"/").replace(n,"")||"/"};d.log=function(c,b){"undefined"!=typeof console&&console[b||"log"](c)};d.isPromise=function(c){return!!c&&("object"==typeof c||
"function"==typeof c)&&"function"==typeof c.then};d.normalize=function(c){var b=0,a=[],e=0,f="";c=d.cleanPath(c);var h=c.replace(/\:([\w-]+)(?:\(([^\/]+?)\))?|(?:\(([^\/]+)\))|(\*{2,})|(\*(?!\*))/g,function(d,h,n,k,l,p,q){return q>b&&(f+=c.slice(b,q)),b=q+d.length,h?(f+="("+h+")",a.push(h),"("+(n||"[\\w-]+")+")"):(f+="("+e+")",a.push(e++),k?"("+k+")":l?"(.*)":p?"([^\\/]*)":void 0)});return b!==c.length&&(f+=c.slice(b)),{regexp:RegExp("^"+h+"/?$"),keys:a,matches:f||c}}},function(p,k,d){function l(a){a=
a||{};this.location=a.location||h.location;this.mode=(this.html5=a.html5)&&h.history?b:g;h.hash||(this.mode=n);a.mode&&(this.mode=a.mode);this.prefix="#"+(a.prefix||"");this.rPrefix=RegExp(this.prefix+"(.*)$");this.interval=a.interval||66;this.root=a.root||"/";this.rRoot=RegExp("^"+this.root);this._fixInitState();this.autolink=!1!==a.autolink;this.curPath=void 0}var h=d(5),c=d(3),n=3,g=1,b=2;c.extend(c.emitable(l),{start:function(){var a=this.getPath();if(this._checkPath=c.bind(this.checkPath,this),
!this.isStart){switch(this.isStart=!0,this.mode===n&&this._fixHashProbelm(a),this.mode){case g:h.on(window,"hashchange",this._checkPath);break;case b:h.on(window,"popstate",this._checkPath);break;case n:this._checkLoop()}this.autolink&&this._autolink();this.curPath=a;this.emit("change",a)}},stop:function(){h.off(window,"hashchange",this._checkPath);h.off(window,"popstate",this._checkPath);clearTimeout(this.tid);this.isStart=!1;this._checkPath=null},checkPath:function(a){a=this.getPath();var b=this.curPath;
a===b&&this.iframe&&(a=this.getPath(this.iframe.location));a!==b&&(this.iframe&&this.nav(a,{silent:!0}),this.curPath=a,this.emit("change",a))},getPath:function(a){var e;a=a||this.location;return this.mode!==b?(e=a.href.match(this.rPrefix),e&&e[1]?e[1]:""):c.cleanPath((a.pathname+a.search||"").replace(this.rRoot,"/"))},nav:function(a,e){var f=this.iframe;e=e||{};a=c.cleanPath(a);this.curPath!=a&&(this.curPath=a,this.mode!==b?(this._setHash(this.location,a,e.replace),f&&this.getPath(f.location)!==a&&
(e.replace||f.document.open().close(),this._setHash(this.iframe.location,a,e.replace))):history[e.replace?"replaceState":"pushState"]({},e.title||"",c.cleanPath(this.root+a)),e.silent||this.emit("change",a))},_autolink:function(){if(this.mode===b){var a=(this.prefix,this);h.on(document.body,"click",function(b){var c=b.target||b.srcElement;if("a"===c.tagName.toLowerCase()&&(c=(c=(h.getHref(c)||"").match(a.rPrefix))&&c[1]?c[1]:""))return b.preventDefault&&b.preventDefault(),a.nav(c),b.returnValue=!1})}},
_setHash:function(a,b,c){var d=a.href.replace(/(javascript:|#).*$/,"");c?a.replace(d+this.prefix+b):a.hash=this.prefix+b},_checkLoop:function(){var a=this;this.tid=setTimeout(function(){a._checkPath();a._checkLoop()},this.interval)},_fixInitState:function(){var a,e,f=c.cleanPath(this.location.pathname);this.mode!==b&&this.html5?(e=f.replace(this.rRoot,""),e&&this.location.replace(this.root+this.prefix+e)):this.mode===b&&(a=this.location.hash.replace(this.prefix,""),a&&history.replaceState({},document.title,
c.cleanPath(this.root+a)))},_fixHashProbelm:function(a){var b=document.createElement("iframe"),c=document.body;b.src="javascript:;";b.style.display="none";b.tabIndex=-1;b.title="";this.iframe=c.insertBefore(b,c.firstChild).contentWindow;this.iframe.document.open().close();this.iframe.location.hash="#"+a}});p.exports=l},function(p,k){var d=window,l=document;p.exports={hash:"onhashchange"in d&&(!l.documentMode||7<l.documentMode),history:d.history&&"onpopstate"in d,location:d.location,getHref:function(d){return"href"in
d?d.getAttribute("href",2):d.getAttribute("href")},on:"addEventListener"in d?function(d,c,k){return d.addEventListener(c,k)}:function(d,c,k){return d.attachEvent("on"+c,k)},off:"removeEventListener"in d?function(d,c,k){return d.removeEventListener(c,k)}:function(d,c,k){return d.detachEvent("on"+c,k)}}}])});
